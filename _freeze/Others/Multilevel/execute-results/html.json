{
  "hash": "8064ad142b187c3bb86df6d9f1fd92de",
  "result": {
    "markdown": "---\ntitle: \"マルチレベルモデルは点推定値に影響を及ぼすか？\"\nexecute: \n  cache: true\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(lmerTest)\nlibrary(broom)\nlibrary(broom.mixed)\n```\n:::\n\n\n## マルチレベルモデルにおけるよくある誤解\n\n「マルチレベルモデルでやんなきゃ係数にバイアスが...」←ホント？\n\n## データ生成\n\nマルチレベルのデータを考える\nサンプルサイズ1000、グループ数50のデータ\n\n\\begin{align}\ny_{ig} \\sim 0.5x_{ig} + \\mathrm{Normal}(\\theta_g, 1) \\\\\n\\theta_g \\sim \\mathrm{Normal}(0, 3) \\\\\nx_i \\sim \\mathrm{Normal}(0, 1)\n\\end{align}\n\n\n::: {.cell hash='Multilevel_cache/html/unnamed-chunk-2_993da7ae4b3a770f793f9ddbfd5653a1'}\n\n```{.r .cell-code}\ndgp <- function(samplesize = 1000) {\n  tibble(\n    id = 1:samplesize,\n    group = rep(1:50, 20),\n    x = rnorm(samplesize, mean = 0, sd = 1),\n  ) |> \n    group_by(group) |> \n    mutate(group_mean = rnorm(1, mean = 0, sd = 3)) |> \n    ungroup() |> \n    mutate(y = 0.5*x + rnorm(samplesize, mean = group_mean, sd = 1))\n}\n\ndata <- dgp()\n```\n:::\n\n::: {.cell hash='Multilevel_cache/html/unnamed-chunk-3_cee3be06ddb41a0a1b5cf2e9b5320f43'}\n\n```{.r .cell-code}\nlm(y ~ x, data = data) |> \n  summary()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nlm(formula = y ~ x, data = data)\n\nResiduals:\n   Min     1Q Median     3Q    Max \n-7.204 -2.101 -0.026  2.141  8.066 \n\nCoefficients:\n            Estimate Std. Error t value Pr(>|t|)    \n(Intercept) -0.38089    0.09163  -4.157 3.51e-05 ***\nx            0.50111    0.09371   5.347 1.11e-07 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 2.895 on 998 degrees of freedom\nMultiple R-squared:  0.02785,\tAdjusted R-squared:  0.02688 \nF-statistic: 28.59 on 1 and 998 DF,  p-value: 1.107e-07\n```\n:::\n\n```{.r .cell-code}\nlmer(y ~ x + (1|group), data = data) |> \n  summary()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nLinear mixed model fit by REML. t-tests use Satterthwaite's method [\nlmerModLmerTest]\nFormula: y ~ x + (1 | group)\n   Data: data\n\nREML criterion at convergence: 3140.8\n\nScaled residuals: \n    Min      1Q  Median      3Q     Max \n-2.8801 -0.6852 -0.0267  0.6389  3.3316 \n\nRandom effects:\n Groups   Name        Variance Std.Dev.\n group    (Intercept) 7.464    2.732   \n Residual             1.053    1.026   \nNumber of obs: 1000, groups:  group, 50\n\nFixed effects:\n             Estimate Std. Error        df t value Pr(>|t|)    \n(Intercept)  -0.37872    0.38773  49.00115  -0.977    0.333    \nx             0.45115    0.03431 949.88893  13.148   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nCorrelation of Fixed Effects:\n  (Intr)\nx -0.004\n```\n:::\n:::\n\n\n\n## シミュレーション\n\nデータを1000個作成\n\n\n::: {.cell hash='Multilevel_cache/html/unnamed-chunk-4_2eed8e12b687694c3be501587928d0be'}\n\n```{.r .cell-code}\ndata_list <- \n  map(1:1000, \\(x) dgp(1000)) |> \n  enframe()\n```\n:::\n\n\nOLSと変量効果モデルで推定\n\n\n::: {.cell hash='Multilevel_cache/html/unnamed-chunk-5_f71d39484b471caacbba6d54215109fe'}\n\n```{.r .cell-code}\nresult <- \n  data_list |> \n  mutate(\n    lm = map(value, \\(data) lm(y ~ x, data = data)),\n    lmer = map(value, \\(data) lmer(y ~ x + (1|group), data = data))\n  )\n```\n:::\n\n\nxの係数のみ取り出す\n\n\n::: {.cell hash='Multilevel_cache/html/unnamed-chunk-6_a0c7c31c6816eebf2d2c1131a27bb98e'}\n\n```{.r .cell-code}\nres2 <- \n  result |> \n  mutate(\n    lm_res = map(lm, \\(model) {\n      tidy(model) |> \n        select(term, estimate)\n    }),\n    lmer_res = map(lmer, \\(model) {\n      tidy(model) |> \n        select(term, estimate)\n    })\n  ) |> \n  select(name, lm_res, lmer_res) |> \n  pivot_longer(!name, names_to = 'model', values_to = 'value') |> \n  unnest(value) |> \n  filter(term == 'x')\n```\n:::\n\n\n\n結果を図示\n\n- どちらの点推定値も真の値の0.5を中心に分布＝バイアスはない\n- OLSによる点推定値はバリアンスが大きい\n- 変量効果（マルチレベル）モデルによる点推定値はバリアンスが小さい\n\n\n::: {.cell hash='Multilevel_cache/html/unnamed-chunk-7_3ec09fa07d502c502a7e4bf3a29c9657'}\n\n```{.r .cell-code}\nres2 |> \n  ggplot(aes(estimate, fill = model))+\n  geom_vline(xintercept = 0.5, linetype = 'dashed', alpha = 0.5)+\n  geom_histogram(alpha = 0.3, color = 'black', binwidth = 0.02, position = 'identity')+\n  scale_x_continuous(breaks = seq(0, 1, 0.2))\n```\n\n::: {.cell-output-display}\n![](Multilevel_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}