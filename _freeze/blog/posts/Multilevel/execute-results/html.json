{
  "hash": "0669b0be8359841d6cdb53e7b848f7b6",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"マルチレベルモデルは点推定値に影響を及ぼすか？\"\ndate: 2024-02-22\ncategories: [Others]\nexecute: \n  cache: true\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(lmerTest)\nlibrary(broom)\nlibrary(broom.mixed)\n```\n:::\n\n\n\n## マルチレベルモデルにおけるよくある誤解\n\n「マルチレベルモデルでやんなきゃ係数にバイアスが...」←ホント？\n\n## データ生成\n\nマルチレベルのデータを考える\nサンプルサイズ1000、グループ数50のデータ\n\n\\begin{align}\ny_{ig} \\sim 0.5x_{ig} + \\mathrm{Normal}(\\theta_g, 1) \\\\\n\\theta_g \\sim \\mathrm{Normal}(0, 3) \\\\\nx_i \\sim \\mathrm{Normal}(0, 1)\n\\end{align}\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndgp <- function(samplesize = 1000) {\n  tibble(\n    id = 1:samplesize,\n    group = rep(1:50, 20),\n    x = rnorm(samplesize, mean = 0, sd = 1),\n  ) |> \n    group_by(group) |> \n    mutate(group_mean = rnorm(1, mean = 0, sd = 3)) |> \n    ungroup() |> \n    mutate(y = 0.5*x + rnorm(samplesize, mean = group_mean, sd = 1))\n}\n\ndata <- dgp()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlm(y ~ x, data = data) |> \n  summary()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nlm(formula = y ~ x, data = data)\n\nResiduals:\n    Min      1Q  Median      3Q     Max \n-9.3427 -2.6225  0.0757  2.6275  7.6910 \n\nCoefficients:\n            Estimate Std. Error t value Pr(>|t|)    \n(Intercept)   0.1105     0.1040   1.063 0.288194    \nx             0.3755     0.1033   3.635 0.000292 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 3.29 on 998 degrees of freedom\nMultiple R-squared:  0.01307,\tAdjusted R-squared:  0.01208 \nF-statistic: 13.21 on 1 and 998 DF,  p-value: 0.0002921\n```\n\n\n:::\n\n```{.r .cell-code}\nlmer(y ~ x + (1|group), data = data) |> \n  summary()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLinear mixed model fit by REML. t-tests use Satterthwaite's method [\nlmerModLmerTest]\nFormula: y ~ x + (1 | group)\n   Data: data\n\nREML criterion at convergence: 3124.4\n\nScaled residuals: \n    Min      1Q  Median      3Q     Max \n-3.0764 -0.6308 -0.0189  0.6780  3.5932 \n\nRandom effects:\n Groups   Name        Variance Std.Dev.\n group    (Intercept) 9.991    3.161   \n Residual             1.020    1.010   \nNumber of obs: 1000, groups:  group, 50\n\nFixed effects:\n             Estimate Std. Error        df t value Pr(>|t|)    \n(Intercept)   0.10994    0.44814  48.99953   0.245    0.807    \nx             0.46983    0.03281 949.67653  14.321   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nCorrelation of Fixed Effects:\n  (Intr)\nx 0.000 \n```\n\n\n:::\n:::\n\n\n\n\n## シミュレーション\n\nデータを1000個作成\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_list <- \n  map(1:1000, \\(x) dgp(1000)) |> \n  enframe()\n```\n:::\n\n\n\nOLSと変量効果モデルで推定\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nresult <- \n  data_list |> \n  mutate(\n    lm = map(value, \\(data) lm(y ~ x, data = data)),\n    lmer = map(value, \\(data) lmer(y ~ x + (1|group), data = data))\n  )\n```\n:::\n\n\n\nxの係数のみ取り出す\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nres2 <- \n  result |> \n  mutate(\n    lm_res = map(lm, \\(model) {\n      tidy(model) |> \n        select(term, estimate)\n    }),\n    lmer_res = map(lmer, \\(model) {\n      tidy(model) |> \n        select(term, estimate)\n    })\n  ) |> \n  select(name, lm_res, lmer_res) |> \n  pivot_longer(!name, names_to = 'model', values_to = 'value') |> \n  unnest(value) |> \n  filter(term == 'x')\n```\n:::\n\n\n\n\n結果を図示\n\n- どちらの点推定値も真の値の0.5を中心に分布＝バイアスはない\n- OLSによる点推定値はバリアンスが大きい\n- 変量効果（マルチレベル）モデルによる点推定値はバリアンスが小さい\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nres2 |> \n  ggplot(aes(estimate, fill = model))+\n  geom_vline(xintercept = 0.5, linetype = 'dashed', alpha = 0.5)+\n  geom_histogram(alpha = 0.3, color = 'black', binwidth = 0.02, position = 'identity')+\n  scale_x_continuous(breaks = seq(0, 1, 0.2))\n```\n\n::: {.cell-output-display}\n![](Multilevel_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}